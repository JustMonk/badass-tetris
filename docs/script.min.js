const COLORS={red:"#d67070",green:"#70d678",blue:"#70acd6",yellow:"#e5e507"};function adjust(t,e){return"#"+t.replace(/^#/,"").replace(/../g,t=>("0"+Math.min(255,Math.max(0,parseInt(t,16)+e)).toString(16)).substr(-2))}function randomInteger(t,e){let r=t+Math.random()*(e+1-t);return Math.floor(r)}class TetrisGame{constructor(t={}){this.interval=t.interval||700,this.intervalId=null,this.createNodes(t.height,t.container);const e=document.getElementById("game-canvas"),r=e.getContext("2d"),i=e.width,o=e.height,a=o/20,s=o,n=s/2+a,l=(n-2*a)/10,c=(s-2*a)/20,d=o,h=n/1.5,u=h/8,g=u/2,v=u+g+u/4,S=h/40;let y={width:h,height:d},f={width:n,height:s},x={width:h,height:d};this.setupCanvas(e,y,f,x),this.canvasConfig={borderColorLight:"#869cc5",borderColor:"#5272ad",controlBackground:"#d7deeb",borderSize:S,fontSize:u,fontPadding:g,scoreBlockHeight:v,sideAreaWidth:h,sideAreaHeight:d,canvas:e,ctx:r,canvasWidth:i,canvasHeight:o,padding:a,collsCount:10,rowsCount:20,blockWidth:l,blockHeight:c,mainAreaHeight:s,mainAreaWidth:n},this.currentState={field:{},activeFigure:null,nextFigure:null,score:0,breaks:0,gameOver:!1},this.controls={startButtonActive:!1,quitButtonActive:!1},e.addEventListener("mousemove",t=>{let e=t.offsetX,r=t.offsetY;this.checkStartButtonHover(e,r),this.checkQuitButtonHover(e,r)}),e.addEventListener("click",t=>(t.preventDefault(),t.stopPropagation(),t.cancelBubble=!0,this.controls.startButtonActive?this.startButtonClick():this.controls.quitButtonActive&&this.quitButtonClick(),!1)),document.fonts.ready.then(()=>{this.drawScore(),this.drawState(),this.drawControls()}),this.moveFigure=this.moveFigure.bind(this)}resetState(){this.currentState={field:{},activeFigure:null,nextFigure:null,score:0,breaks:0,gameOver:!1}}checkStartButtonHover(t,e){const{sideAreaWidth:r,mainAreaWidth:i,padding:o,scoreBlockHeight:a,canvas:s}=this.canvasConfig;let n=r+i;t>=n&&t<=n+(r-o)&&e>=o&&e<=o+a?(this.controls.startButtonActive=!0,s.style.cursor="pointer",this.drawControls()):this.controls.startButtonActive&&(this.controls.startButtonActive=!1,s.style.cursor="default",this.drawControls())}checkQuitButtonHover(t,e){const{sideAreaWidth:r,mainAreaWidth:i,padding:o,scoreBlockHeight:a,canvas:s}=this.canvasConfig;let n=r+i,l=a+o/2+o;t>=n&&t<=n+(r-o)&&e>=l&&e<=l+a?(this.controls.quitButtonActive=!0,s.style.cursor="pointer",this.drawControls()):this.controls.quitButtonActive&&(this.controls.quitButtonActive=!1,s.style.cursor="default",this.drawControls())}startButtonClick(){this.intervalId||this.currentState.activeFigure?this.intervalId?(clearInterval(this.intervalId),this.intervalId=null):this.intervalId||this.currentState.gameOver?this.start():this.runGameLoop():this.start(),this.drawControls()}quitButtonClick(){this.resetState(),this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),document.removeEventListener("keydown",this.moveFigure),this.drawScore(),this.drawState(),this.drawControls()}createNodes(t=600,e=document.body){let r=document.createElement("div");r.id="game-wrapper",r.style=`position: relative; border: 1px solid rgb(128 128 128 / 32%); width: 50px; height: ${t}px; font-family: 'Bebas Neue', cursive; user-select: none; margin: 0 auto;`;let i=document.createElement("canvas");i.width="50",i.height=t,i.id="game-canvas",i.style="position: absolute; z-index: 1;",r.appendChild(i);let o=document.createElement("canvas");o.id="bg-canvas",i.width="50",o.height=t,i.style="position: absolute; z-index: 0;",r.appendChild(o),e.appendChild(r)}setupCanvas(t,e,r,i){t.width=e.width+r.width+i.width;let o=t.width,a=document.getElementById("bg-canvas");a.width=t.width;let s=a.getContext("2d");s.fillStyle="#f0f6ff",s.rect(0,0,t.width,t.height),s.fill();for(var n=o,l=0;l<n;l++){s.beginPath(),s.strokeStyle=l%2?"#ffffff":"rgba(93, 135, 211, 0.15)",s.lineWidth=2,s.lineCap="round",s.moveTo(2*l+2-o,0),s.lineTo(0+2*l+2,o),s.stroke()}document.getElementById("game-wrapper").style.width=t.width+"px"}runGameLoop(){this.intervalId=setInterval(()=>{this.getNext(),this.drawState()},this.interval)}start(){this.resetState(),this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.currentState.activeFigure=this.createRandomFigure(),this.currentState.nextFigure=this.createRandomFigure(),document.addEventListener("keydown",this.moveFigure),this.drawState(),this.drawControls(),this.runGameLoop()}setMainArea(){const{ctx:t,sideAreaWidth:e,padding:r}=this.canvasConfig;let i=e;t.translate(i+r,0+r)}drawGrid(){const{ctx:t,blockWidth:e,blockHeight:r,borderSize:i,canvasWidth:o,canvasHeight:a,padding:s,rowsCount:n,collsCount:l,mainAreaHeight:c,mainAreaWidth:d}=this.canvasConfig;t.save(),t.fillStyle="rgba(255,255,255,0.5)",t.fillRect(0,0,d-2*s,c-2*s),t.lineWidth=i,t.strokeStyle="#5272ad",t.strokeRect(0-i/2,0-i/2,d-2*s+i,c-2*s+i),t.restore(),t.strokeStyle="lightgrey",t.beginPath();for(let r=0;r<=l;r++)t.moveTo(e*r,0),t.lineTo(e*r,c-2*s);for(let e=0;e<=n;e++)t.moveTo(0,r*e),t.lineTo(d-2*s,r*e);t.closePath(),t.stroke()}drawState(){const{ctx:t,blockWidth:e,blockHeight:r,borderSize:i,padding:o,canvasWidth:a,canvasHeight:s,rowsCount:n,collsCount:l,mainAreaWidth:c,mainAreaHeight:d}=this.canvasConfig;if(t.save(),this.drawScore(),this.drawControls(),this.setMainArea(),t.clearRect(0-o,0-o,c,d),this.drawGrid(),!this.currentState.activeFigure)return t.restore();this.currentState.activeFigure.coords.forEach(i=>{let o=t.createLinearGradient((i.x-1)*e+e,(i.y-1)*r,(i.x-1)*e+e,(i.y-1)*r+r);o.addColorStop(0,adjust(this.currentState.activeFigure.color,50)),o.addColorStop(.5,adjust(this.currentState.activeFigure.color,10)),o.addColorStop(1,adjust(this.currentState.activeFigure.color,-20)),t.fillStyle=o,t.fillRect((i.x-1)*e,(i.y-1)*r,e,r),t.save();let a=e/9;t.lineWidth=a,t.strokeStyle="#323232",t.strokeRect((i.x-1)*e+a/2,(i.y-1)*r+a/2,e-a,r-a);let s=t.createLinearGradient((i.x-1)*e,(i.y-1)*r,(i.x-1)*e+e,(i.y-1)*r+r);s.addColorStop(0,adjust(this.currentState.activeFigure.color,-50)),s.addColorStop(.5,adjust(this.currentState.activeFigure.color,-25)),s.addColorStop(1,adjust(this.currentState.activeFigure.color,-200)),t.strokeStyle=s,t.strokeRect((i.x-1)*e+a,(i.y-1)*r+a,e-2*a,r-2*a),t.restore()}),this.drawField(),t.restore()}drawField(){const{ctx:t,blockWidth:e,blockHeight:r,canvasWidth:i,canvasHeight:o,rowsCount:a,collsCount:s}=this.canvasConfig;Object.keys(this.currentState.field).forEach(i=>{let o=i.split(":")[0],a=i.split(":")[1],s=t.createLinearGradient((i.split(":")[0]-1)*e+e,(i.split(":")[1]-1)*r,(i.split(":")[0]-1)*e+e,(i.split(":")[1]-1)*r+r);s.addColorStop(0,adjust(this.currentState.field[i],50)),s.addColorStop(.5,adjust(this.currentState.field[i],10)),s.addColorStop(1,adjust(this.currentState.field[i],-20)),t.fillStyle=s,t.fillRect((i.split(":")[0]-1)*e,(i.split(":")[1]-1)*r,e,r),t.save();let n=e/9;t.lineWidth=n,t.strokeStyle="#323232",t.strokeRect((o-1)*e+n/2,(a-1)*r+n/2,e-n,r-n);let l=t.createLinearGradient((o-1)*e,(a-1)*r,(o-1)*e+e,(a-1)*r+r);l.addColorStop(0,adjust(this.currentState.field[i],-50)),l.addColorStop(.5,adjust(this.currentState.field[i],-25)),l.addColorStop(1,adjust(this.currentState.field[i],-200)),t.strokeStyle=l,t.strokeRect((o-1)*e+n,(a-1)*r+n,e-2*n,r-2*n),t.restore()})}drawScore(){const{ctx:t,controlBackground:e,scoreBlockHeight:r,fontSize:i,fontPadding:o,sideAreaWidth:a,padding:s,borderSize:n,sideAreaHeight:l,mainAreaWidth:c,mainAreaHeight:d,blockWidth:h,blockHeight:u}=this.canvasConfig;if(t.save(),t.strokeStyle="#5272ad",t.translate(0+s,0+s),t.clearRect(0-n,0-n,a,l-2*s),t.lineWidth=n,t.fillStyle=e,t.fillRect(0,0,a-s-n,i+o+i/4),t.strokeRect(0,0,a-s-n,i+o+i/4),t.font=`${i}px Bebas Neue`,t.textBaseline="top",t.fillStyle="#425b8b",t.fillText(`Score: ${this.currentState.score}`,o,i/2,a),t.fillStyle="#d7deeb",t.fillRect(0,i+o+i/4,a-s-n,i+o+i/4),t.strokeRect(0,i+o+i/4,a-s-n,i+o+i/4),t.font=`${i}px Bebas Neue`,t.textBaseline="top",t.fillStyle="#425b8b",t.fillText(`Breaks: ${this.currentState.breaks}`,o,i+o+i/4+i/2,a),t.fillStyle="rgba(215, 222, 235, 0.36)",t.fillRect(0,3*r,a-s-n,3*r),t.strokeStyle="#869cc5",t.strokeRect(0,3*r,a-s-n,3*r),!this.currentState.nextFigure)return t.restore();let g=this.currentState.nextFigure.coords.map(t=>t.x).sort(),v=this.currentState.nextFigure.coords.map(t=>t.y).sort(),S=(g[g.length-1]-g[0]+1)*h/2,y=(v[g.length-1]-v[0]+1)*u/2,f=(a-s-n)/2,x=3*r/2;t.translate(f-S,3*r+x-y),this.currentState.nextFigure.coords.forEach(e=>{let r=t.createLinearGradient((e.x-1)*h+h,(e.y-1)*u,(e.x-1)*h+h,(e.y-1)*u+u);r.addColorStop(0,adjust(this.currentState.nextFigure.color,50)),r.addColorStop(.5,adjust(this.currentState.nextFigure.color,10)),r.addColorStop(1,adjust(this.currentState.nextFigure.color,-20)),t.fillStyle=r,t.fillRect((e.x-g[0])*h,(e.y-1)*u,h,u);let i=h/9;t.lineWidth=i,t.strokeStyle="#323232",t.strokeRect((e.x-g[0])*h+i/2,(e.y-1)*u+i/2,h-i,u-i);let o=t.createLinearGradient((e.x-g[0])*h,(e.y-1)*u,(e.x-g[0])*h+h,(e.y-1)*u+u);o.addColorStop(0,adjust(this.currentState.nextFigure.color,-50)),o.addColorStop(.5,adjust(this.currentState.nextFigure.color,-25)),o.addColorStop(1,adjust(this.currentState.nextFigure.color,-200)),t.strokeStyle=o,t.strokeRect((e.x-g[0])*h+i,(e.y-1)*u+i,h-2*i,u-2*i)}),t.restore()}drawControls(){const{ctx:t,borderColorLight:e,borderColor:r,sideAreaWidth:i,scoreBlockHeight:o,borderSize:a,fontSize:s,fontPadding:n,sideAreaHeight:l,padding:c,mainAreaWidth:d,mainAreaHeight:h}=this.canvasConfig;t.save();const u=i+d;t.translate(u+a,0+c),t.clearRect(0-a,0-a,i,h-2*c+2*a),this.controls.startButtonActive?t.fillStyle=adjust("#d7deeb",-50):t.fillStyle="#d7deeb",t.lineWidth=a,t.strokeStyle=r,t.fillRect(0,0,i-c,o),t.strokeRect(0,0,i-c,o),t.font=`${s}px Bebas Neue`,t.textBaseline="top",t.textAlign="center",t.fillStyle="#000";let g=this.intervalId?"Pause":"Start";!this.intervalId&&this.currentState.activeFigure&&(g="Resume"),this.currentState.gameOver&&(g="Restart"),t.fillText(g,i/2+n-c,n,i),this.controls.quitButtonActive?t.fillStyle=adjust("#d7deeb",-50):t.fillStyle="#d7deeb",t.strokeStyle=r,t.fillRect(0,o+c/2,i-c,o),t.strokeRect(0,o+c/2,i-c,o),t.font=`${s}px Bebas Neue`,t.textBaseline="top",t.textAlign="center",t.fillStyle="#000",t.fillText("Exit",i/2+n-c,n+o+c/2,i),t.strokeStyle=e,t.fillStyle="rgba(215, 222, 235, 0.36)",t.fillRect(0,l-2*c+a-3*o,i-c,3*o-n/1.5),t.strokeRect(0,l-2*c+a-3*o,i-c,3*o-n/1.5),t.fillStyle="#979797",t.textAlign="center",t.fillText("🠕 rotate",i/2+n-c,n+(l-2*c+a)-3*o,i),t.fillText("🠔 move left",i/2+n-c,n+(l-2*c+a)-3*o+s,i),t.fillText("🠖 move right",i/2+n-c,n+(l-2*c+a)-3*o+2*s,i),t.fillText("🠗 speed-up",i/2+n-c,n+(l-2*c+a)-3*o+3*s,i),t.restore()}getNext(){const t=this.currentState;let e=t.activeFigure.coords.some(t=>this.checkCollision(t.x,t.y+1));if(e||(t.activeFigure.coords=t.activeFigure.coords.map(t=>({x:t.x,y:t.y+1})),t.activeFigure.top&&(t.activeFigure.top.y+=1)),e){t.activeFigure.coords.forEach(e=>{t.field[`${e.x}:${e.y}`]=t.activeFigure.color}),this.checkRowFilled(),t.activeFigure=t.nextFigure,t.nextFigure=this.createRandomFigure(),t.activeFigure.coords.some(t=>this.checkCollision(t.x,t.y))&&this.endGame()}t.score++}checkRowFilled(){for(let t=this.canvasConfig.rowsCount;t>1;t--)if(Object.keys(this.currentState.field).filter(e=>e.split(":")[1]===`${t}`).length===this.canvasConfig.collsCount){Object.keys(this.currentState.field).forEach(e=>{e.split(":")[1]===`${t}`&&delete this.currentState.field[e]}),this.currentState.score+=100,this.currentState.breaks+=1;let e=Object.assign({},this.currentState.field),r=Object.entries(this.currentState.field).filter(e=>+e[0].split(":")[1]<t);r.forEach(t=>{delete e[t[0]]}),r.forEach(t=>{let r=t[0].split(":")[0],i=t[0].split(":")[1];e[`${r}:${+i+1}`]=t[1]}),this.currentState.field=e,this.checkRowFilled();break}}checkCollision(t,e){return t<1||t>this.canvasConfig.collsCount||(e<1||e>this.canvasConfig.rowsCount||!!this.currentState.field[`${t}:${e}`])}moveFigure(t){if(!this.intervalId)return;if("ArrowLeft"!==t.key&&"ArrowRight"!==t.key&&"ArrowDown"!==t.key&&"ArrowUp"!==t.key)return;let e=!1;if("ArrowLeft"===t.key){let t=[];this.currentState.activeFigure.coords.forEach(r=>{this.checkCollision(r.x-1,r.y)&&(e=!0),t.push({x:e?r.x:r.x-1,y:r.y})}),t.some(t=>this.checkCollision(t.x,t.y))&&(e=!0),e||(this.currentState.activeFigure.coords=t),this.currentState.activeFigure.top&&(this.currentState.activeFigure.top={x:e?this.currentState.activeFigure.top.x:this.currentState.activeFigure.top.x-1,y:this.currentState.activeFigure.top.y})}if("ArrowRight"===t.key){let t=[];this.currentState.activeFigure.coords.forEach(r=>{this.checkCollision(r.x+1,r.y)&&(e=!0),t.push({x:e?r.x:r.x+1,y:r.y})}),t.some(t=>this.checkCollision(t.x,t.y))&&(e=!0),e||(this.currentState.activeFigure.coords=t),this.currentState.activeFigure.top&&(this.currentState.activeFigure.top={x:e?this.currentState.activeFigure.top.x:this.currentState.activeFigure.top.x+1,y:this.currentState.activeFigure.top.y})}if("ArrowDown"===t.key&&this.getNext(),"ArrowUp"===t.key){let t=[];this.currentState.activeFigure.coords.forEach(e=>{if(!this.currentState.activeFigure.top)return t.push(e);t.push(this.getOffset90(this.currentState.activeFigure.top.x,this.currentState.activeFigure.top.y,e.x,e.y))}),t.some(t=>this.checkCollision(t.x,t.y))&&(e=!0),e||(this.currentState.activeFigure.coords=t)}t.preventDefault(),this.drawState()}createRandomFigure(){const t=Object.values({line:{coords:[{x:4,y:1},{x:5,y:1},{x:6,y:1},{x:7,y:1}],top:{x:5,y:1}},square:{coords:[{x:5,y:1},{x:5,y:2},{x:6,y:1},{x:6,y:2}],top:!1},tetraL:{coords:[{x:4,y:1},{x:4,y:2},{x:5,y:2},{x:6,y:2}],top:{x:5,y:2}},tetraLInverse:{coords:[{x:6,y:1},{x:4,y:2},{x:5,y:2},{x:6,y:2}],top:{x:5,y:2}},tetraZ:{coords:[{x:4,y:1},{x:5,y:1},{x:5,y:2},{x:6,y:2}],top:{x:5,y:2}},tetraS:{coords:[{x:6,y:1},{x:5,y:1},{x:5,y:2},{x:4,y:2}],top:{x:5,y:2}},tetraT:{coords:[{x:5,y:1},{x:4,y:2},{x:5,y:2},{x:6,y:2}],top:{x:5,y:2}}});let e=t[randomInteger(0,t.length-1)],r=Object.values(COLORS);return this.currentState.activeFigure&&(r=r.filter(t=>t!==this.currentState.activeFigure.color)),e.color=r[randomInteger(0,r.length-1)],e}getOffset90(t,e,r,i){return{x:e+t-i,y:r-(t-e)}}endGame(){clearInterval(this.intervalId),this.intervalId=null,this.currentState.gameOver=!0}destroy(){this.endGame(),this.resetState();let t=document.getElementById("game-wrapper");t&&t.remove()}}let game=new TetrisGame;document.getElementById("resolution-slider").addEventListener("change",t=>{game.destroy(),game=new TetrisGame({height:t.target.value});let e=document.getElementById("game-canvas"),r=`${e.width}x${e.height}`;document.getElementById("resolution-value").textContent=r});